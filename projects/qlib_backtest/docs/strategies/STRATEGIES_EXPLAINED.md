# Qlib å†…ç½®ç­–ç•¥å›æµ‹ - æŠ¥é”™åŸå› ä¸è§£å†³æ–¹æ¡ˆ

## âŒ æŠ¥é”™åŸå› åˆ†æ

### 1. ä¸»è¦é”™è¯¯ï¼š`AttributeError: Please run qlib.init() first`

**é”™è¯¯ä¿¡æ¯ï¼š**
```
AttributeError: Please run qlib.init() first using qlib. Did you mean: '__class__'?
```

**åŸå› ï¼š**
- Qlib çš„ç­–ç•¥æ¨¡å—ä¾èµ–äº Qlib çš„æ•°æ®ç³»ç»Ÿ
- åœ¨è®¿é—®ç­–ç•¥ç±»ä¹‹å‰ï¼Œå¿…é¡»å…ˆåˆå§‹åŒ– Qlibï¼š`qlib.init(provider_uri=..., region=REG_CN)`
- åˆå§‹åŒ–ä¼šåŠ è½½æ•°æ®æä¾›è€…ã€é…ç½®æ—¥å¿—ç­‰

**è§¦å‘åœºæ™¯ï¼š**
```python
# âŒ é”™è¯¯æ–¹å¼
from qlib.contrib.strategy import signal_strategy  # ç›´æ¥å¯¼å…¥ï¼Œæœªåˆå§‹åŒ–
# è®¿é—®ç­–ç•¥ç±»æ—¶ä¼šæŠ¥é”™

# âœ… æ­£ç¡®æ–¹å¼
import qlib
qlib.init(provider_uri="...", region=REG_CN)  # å…ˆåˆå§‹åŒ–
from qlib.contrib.strategy import signal_strategy
```

### 2. Gym è­¦å‘Š

**è­¦å‘Šä¿¡æ¯ï¼š**
```
Gym has been unmaintained since 2022 and does not support NumPy 2.0
Please upgrade to Gymnasium
```

**åŸå› ï¼š**
- Qlib ä¾èµ–çš„ `gym` åº“å·²ç»åœæ­¢ç»´æŠ¤
- NumPy 2.0 ä¸æ—§ç‰ˆ gym ä¸å…¼å®¹
- Qlib è¿˜æœªè¿ç§»åˆ° `gymnasium`

**å½±å“ï¼š**
- ä¸å½±å“åŠŸèƒ½ï¼Œåªæ˜¯è­¦å‘Š
- å¯ä»¥å¿½ç•¥æˆ–ç”¨ `warnings.filterwarnings('ignore')`

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¸ä¾èµ– qlib çš„ç­–ç•¥ç±»ï¼ˆæ¨èï¼‰âœ…

**åŸç†ï¼š**
- æ ¹æ®ç­–ç•¥åŸç†ï¼Œç”¨ Python ç›´æ¥å®ç°
- é¿å…å¯¼å…¥ qlib ç­–ç•¥æ¨¡å—
- æ›´çµæ´»ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹

**å®ç°æ–¹å¼ï¼š**
```python
# 1. å®ç°ç­–ç•¥ç±»
class TopKStrategy:
    def __init__(self, topk=1, lookback=20):
        self.topk = topk
        self.lookback = lookback
    
    def generate_signal(self, df):
        # è®¡ç®—åŠ¨é‡
        df['momentum'] = df['close'].pct_change(periods=self.lookback)
        
        # ç”Ÿæˆä¿¡å·
        df['position'] = 0
        df.loc[df['momentum'] > 0, 'position'] = 1
        df.loc[df['momentum'] < 0, 'position'] = -1
        
        return df

# 2. ä½¿ç”¨ç­–ç•¥
strategy = TopKStrategy(topk=1, lookback=20)
df_with_signal = strategy.generate_signal(df)

# 3. è¿è¡Œå›æµ‹
results = run_backtest(df_with_signal)
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ— éœ€åˆå§‹åŒ– qlib
- âœ… ä»£ç æ›´æ¸…æ™°
- âœ… æ˜“äºè°ƒè¯•å’Œä¼˜åŒ–

### æ–¹æ¡ˆäºŒï¼šå…ˆåˆå§‹åŒ– qlibï¼ˆå¦‚æœéœ€è¦ä½¿ç”¨ qlib çš„å›æµ‹æ¡†æ¶ï¼‰

```python
import qlib
from qlib.config import REG_CN

# åˆå§‹åŒ– qlib
qlib.init(provider_uri="/path/to/data", region=REG_CN)

# ç„¶åå¯¼å…¥ç­–ç•¥
from qlib.contrib.strategy import signal_strategy
```

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦ä½¿ç”¨ qlib çš„å®Œæ•´å›æµ‹æ¡†æ¶
- éœ€è¦ä¸ qlib çš„ ML æ¨¡å—é›†æˆ
- éœ€è¦å¤šèµ„äº§ç»„åˆä¼˜åŒ–

## ğŸ“Š å›æµ‹ç»“æœï¼ˆ2023å¹´ï¼Œ1åˆ†é’Ÿçº§åˆ«ï¼‰

### æ±‡æ€»è¡¨

| ç­–ç•¥ç±»å‹ | ç­–ç•¥åç§° | äº¤æ˜“æ¬¡æ•° | ç´¯è®¡æ”¶ç›Š | å¹´åŒ–æ”¶ç›Š | æœ€å¤§å›æ’¤ | å¤æ™®æ¯”ç‡ | èƒœç‡ |
|----------|-----------|----------|----------|----------|----------|----------|------|
| **ä¿¡å·ç­–ç•¥** | TopK | 13,169 | -54.36% | -43.63% | 55.25% | -3.63 | 47.57% |
| **ä¿¡å·ç­–ç•¥** | Enhanced Indexing | 966 | **92.18%** | **61.18%** | **2.25%** | **8.11** | **60.76%** |
| **è§„åˆ™ç­–ç•¥** | SBB | 55,915 | -98.52% | -95.40% | 98.54% | -21.26 | 43.41% |
| **è§„åˆ™ç­–ç•¥** | SBB EMA | 55,915 | -98.52% | -95.40% | 98.54% | -21.26 | 43.41% |
| **è§„åˆ™ç­–ç•¥** | TWAP | 3,364 | -2.97% | -2.18% | 5.62% | -0.74 | 48.87% |

### æ’å

**ç»¼åˆè¡¨ç°æ’åºï¼ˆå¤æ™®æ¯”ç‡ + ç´¯è®¡æ”¶ç›Šï¼‰ï¼š**

1. ğŸ¥‡ **Enhanced Indexing** - æœ€ä½³
   - ç´¯è®¡æ”¶ç›Šï¼š92.18%
   - å¤æ™®æ¯”ç‡ï¼š8.11
   - èƒœç‡ï¼š60.76%
   - ç‰¹ç‚¹ï¼šä½é¢‘ã€é«˜èƒœç‡ã€ä½å›æ’¤

2. ğŸ¥ˆ **TWAP** - ä¸­ç­‰
   - ç´¯è®¡æ”¶ç›Šï¼š-2.97%
   - å¤æ™®æ¯”ç‡ï¼š-0.74
   - ç‰¹ç‚¹ï¼šæ‰§è¡Œç­–ç•¥ï¼Œä¸æ˜¯çœŸæ­£çš„ä¿¡å·ç­–ç•¥

3. ğŸ¥‰ **TopK** - è¾ƒå·®
   - ç´¯è®¡æ”¶ç›Šï¼š-54.36%
   - å¤æ™®æ¯”ç‡ï¼š-3.63
   - ç‰¹ç‚¹ï¼šé«˜é¢‘ã€ä½èƒœç‡

4. âŒ **SBB / SBB EMA** - æœ€å·®
   - ç´¯è®¡æ”¶ç›Šï¼š-98.52%
   - å¤æ™®æ¯”ç‡ï¼š-21.26
   - ç‰¹ç‚¹ï¼šè¶…é«˜é¢‘ã€æé«˜äº¤æ˜“æˆæœ¬

---

## ğŸ“š ç­–ç•¥è¯¦è§£

### ä¸€ã€ä¿¡å·ç­–ç•¥ï¼ˆSignal Strategyï¼‰

#### 1. TopK ç­–ç•¥

**åŸç†ï¼š**
- ä»ä¸€ç»„èµ„äº§ä¸­é€‰æ‹©è¡¨ç°æœ€å¥½çš„ K ä¸ª
- æŒ‰é¢„æµ‹æ”¶ç›Šæˆ–å› å­å¾—åˆ†æ’åº
- ç­‰æƒé‡æˆ–æŒ‰å¾—åˆ†æƒé‡åˆ†é…

**å®ç°é€»è¾‘ï¼š**
```python
# è®¡ç®—åŠ¨é‡
df['momentum'] = df['close'].pct_change(periods=20)

# åŠ¨é‡ä¸ºæ­£åšå¤šï¼Œä¸ºè´Ÿåšç©º
df.loc[df['momentum'] > 0, 'position'] = 1
df.loc[df['momentum'] < 0, 'position'] = -1
```

**å‚æ•°ï¼š**
- `topk`: é€‰æ‹©çš„èµ„äº§æ•°é‡ï¼ˆè¿™é‡Œä¸º 1ï¼‰
- `lookback`: åŠ¨é‡è®¡ç®—å‘¨æœŸï¼ˆ20ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤šèµ„äº§ç»„åˆä¼˜åŒ–
- å› å­é€‰è‚¡
- é€‚åˆå¤šæ ‡çš„æŠ•èµ„

**å›æµ‹ç»“æœï¼š**
- âŒ åœ¨å•èµ„äº§ä¸Šè¡¨ç°å·®
- åŸå› ï¼šæ²¡æœ‰èµ„äº§æ± å¯ä¾›é€‰æ‹©ï¼Œå˜æˆç®€å•çš„åŠ¨é‡ç­–ç•¥
- 2023å¹´èºçº¹é’¢æ˜¯éœ‡è¡ä¸‹è·Œï¼ŒåŠ¨é‡ç­–ç•¥å¤±æ•ˆ

#### 2. Enhanced Indexingï¼ˆå¢å¼ºæŒ‡æ•°ï¼‰ç­–ç•¥ â­

**åŸç†ï¼š**
- ç»“åˆä¸»åŠ¨ç®¡ç†å’Œè¢«åŠ¨æŠ•èµ„
- ä½¿ç”¨å‡å€¼å›å½’é€»è¾‘
- æ§åˆ¶æ¢æ‰‹ç‡å’Œé£é™©

**å®ç°é€»è¾‘ï¼š**
```python
# è®¡ç®—ç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®
df['ma'] = df['close'].rolling(window=20).mean()
df['std'] = df['close'].rolling(window=20).std()

# è®¡ç®—Z-score
df['z_score'] = (df['close'] - df['ma']) / df['std']

# ä½äºå‡å€¼2ä¸ªæ ‡å‡†å·®ä¹°å…¥
df.loc[df['z_score'] < -2, 'position'] = 1
# é«˜äºå‡å€¼2ä¸ªæ ‡å‡†å·®å–å‡º
df.loc[df['z_score'] > 2, 'position'] = -1
```

**å‚æ•°ï¼š**
- `window`: å‡å€¼å›å½’çª—å£ï¼ˆ20ï¼‰
- `turnover_limit`: æ¢æ‰‹ç‡é™åˆ¶ï¼ˆ0.3ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ‡è¡å¸‚åœº
- å‡å€¼å›å½’
- é£é™©æ§åˆ¶

**å›æµ‹ç»“æœï¼šâœ… æœ€ä½³**
- ç´¯è®¡æ”¶ç›Šï¼š92.18%
- å¤æ™®æ¯”ç‡ï¼š8.11
- èƒœç‡ï¼š60.76%
- æœ€å¤§å›æ’¤ï¼š2.25%
- äº¤æ˜“æ¬¡æ•°ï¼š966ï¼ˆä½é¢‘ï¼‰

**ä¸ºä»€ä¹ˆæ•ˆæœå¥½ï¼Ÿ**
1. 2023å¹´èºçº¹é’¢å¸‚åœºé€‚åˆå‡å€¼å›å½’
2. åœ¨æç«¯ä»·æ ¼ä½ç½®äº¤æ˜“ï¼ˆè¿œç¦»å‡å€¼2ä¸ªæ ‡å‡†å·®ï¼‰
3. ä½é¢‘äº¤æ˜“ï¼Œå‡å°‘æ‰‹ç»­è´¹å’Œæ»‘ç‚¹å½±å“
4. èƒœç‡é«˜ï¼Œç›ˆäºæ¯”å¥½

---

### äºŒã€è§„åˆ™ç­–ç•¥ï¼ˆRule Strategyï¼‰

#### 1. SBBï¼ˆSelect Better Between Barsï¼‰ç­–ç•¥

**åŸç†ï¼š**
- æ¯”è¾ƒç›¸é‚»ä¸¤æ ¹ K çº¿çš„æ”¶ç›˜ä»·
- å¦‚æœåä¸€æ ¹ K çº¿æ›´é«˜ â†’ ä¹°å…¥
- å¦‚æœåä¸€æ ¹ K çº¿æ›´ä½ â†’ å–å‡º

**å®ç°é€»è¾‘ï¼š**
```python
# è®¡ç®—ç›¸é‚» K çº¿å˜åŒ–
df['price_change'] = df['close'].diff()

# ä»·æ ¼ä¸Šæ¶¨åšå¤š
df.loc[df['price_change'] > 0, 'position'] = 1
# ä»·æ ¼ä¸‹è·Œåšç©º
df.loc[df['price_change'] < 0, 'position'] = -1
```

**å‚æ•°ï¼š**
- æ— å‚æ•°ï¼ˆç›´æ¥æ¯”è¾ƒï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- è¶‹åŠ¿æ˜æ˜¾çš„å¸‚åœº
- çŸ­çº¿äº¤æ˜“
- é€‚åˆé«˜é¢‘

**å›æµ‹ç»“æœï¼šâŒ æœ€å·®**
- ç´¯è®¡æ”¶ç›Šï¼š-98.52%
- å¤æ™®æ¯”ç‡ï¼š-21.26
- èƒœç‡ï¼š43.41%
- äº¤æ˜“æ¬¡æ•°ï¼š55,915ï¼ˆè¶…é«˜é¢‘ï¼‰

**ä¸ºä»€ä¹ˆæ•ˆæœå·®ï¼Ÿ**
1. **éœ‡è¡å¸‚åœºå¤±æ•ˆ**ï¼š2023å¹´èºçº¹é’¢éœ‡è¡ï¼Œé¢‘ç¹åè½¬
2. **äº¤æ˜“æˆæœ¬æé«˜**ï¼š55,915æ¬¡äº¤æ˜“ï¼Œæ¯æ¬¡0.05%æ‰‹ç»­è´¹ â‰ˆ 27%æ€»æˆæœ¬
3. **æ— è¶‹åŠ¿åˆ¤æ–­**ï¼šä¸è€ƒè™‘å¤§è¶‹åŠ¿ï¼Œç›²ç›®è·ŸéšçŸ­æœŸæ³¢åŠ¨
4. **èƒœç‡ä½**ï¼š43.41%ï¼Œæ— æ³•è¦†ç›–æˆæœ¬

#### 2. SBB EMA ç­–ç•¥

**åŸç†ï¼š**
- åœ¨ SBB åŸºç¡€ä¸Šå¢åŠ  EMA è¶‹åŠ¿è¿‡æ»¤
- ä¸Šå‡è¶‹åŠ¿ä¸­ï¼šä»·æ ¼ä¸Šæ¶¨ä¹°å…¥ï¼Œä¸‹è·Œå–å‡º
- ä¸‹é™è¶‹åŠ¿ä¸­ï¼šä»·æ ¼ä¸‹è·Œåšç©ºï¼Œä¸Šæ¶¨å¹³ç©º

**å®ç°é€»è¾‘ï¼š**
```python
# è®¡ç®— EMA
df['ema'] = df['close'].ewm(span=20).mean()

# åˆ¤æ–­è¶‹åŠ¿
df['trend'] = np.where(df['close'] > df['ema'], 1, -1)

# ä¸Šå‡è¶‹åŠ¿ä¸­ï¼Œä»·æ ¼ä¸Šæ¶¨ä¹°å…¥
df.loc[(df['trend'] == 1) & (df['price_change'] > 0), 'position'] = 1
# ä¸Šå‡è¶‹åŠ¿ä¸­ï¼Œä»·æ ¼ä¸‹è·Œå–å‡º
df.loc[(df['trend'] == 1) & (df['price_change'] < 0), 'position'] = -1
```

**å‚æ•°ï¼š**
- `ema_period`: EMA å‘¨æœŸï¼ˆ20ï¼‰

**å›æµ‹ç»“æœï¼šâŒ æœ€å·®ï¼ˆä¸ SBB ç›¸åŒï¼‰**
- ç´¯è®¡æ”¶ç›Šï¼š-98.52%
- äº¤æ˜“æ¬¡æ•°ï¼š55,915

**ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¹å–„ï¼Ÿ**
1. EMA è¶‹åŠ¿åˆ¤æ–­æ²¡æœ‰å‡å°‘äº¤æ˜“æ¬¡æ•°
2. æ¯æ¬¡è¶‹åŠ¿å˜åŒ–éƒ½è§¦å‘äº¤æ˜“
3. ä»ç„¶è¶…é«˜é¢‘ï¼Œäº¤æ˜“æˆæœ¬åå™¬æ‰€æœ‰æ”¶ç›Š

#### 3. TWAPï¼ˆTime-Weighted Average Priceï¼‰ç­–ç•¥

**åŸç†ï¼š**
- åœ¨å›ºå®šæ—¶é—´å†…åˆ†æ‰¹æ‰§è¡Œäº¤æ˜“
- å‡å°‘å¸‚åœºå†²å‡»
- é€‚åˆå¤§é¢èµ„é‡‘æ‰§è¡Œ

**å®ç°é€»è¾‘ï¼š**
```python
# æ¯éš”ä¸€å®šæ—¶é—´äº¤æ˜“
df['time_group'] = (df.index - df.index[0]).total_seconds() // (60 * 60)
df['group_count'] = df.groupby('time_group').cumcount() + 1

# æ¯ä¸ªæ—¶é—´ç»„çš„ç¬¬ä¸€ä¸ª bar åšå¤š
df.loc[df['group_count'] == 1, 'position'] = 1
```

**å‚æ•°ï¼š**
- `execution_period`: æ‰§è¡Œå‘¨æœŸï¼ˆ60åˆ†é’Ÿï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤§é¢èµ„é‡‘æ‰§è¡Œ
- å‡å°‘å¸‚åœºå†²å‡»
- ä¸æ˜¯çœŸæ­£çš„ä¿¡å·ç­–ç•¥

**å›æµ‹ç»“æœï¼šä¸­ç­‰**
- ç´¯è®¡æ”¶ç›Šï¼š-2.97%
- å¤æ™®æ¯”ç‡ï¼š-0.74
- äº¤æ˜“æ¬¡æ•°ï¼š3,364

**ä¸ºä»€ä¹ˆä¸­ç­‰ï¼Ÿ**
1. è¿™æ˜¯ä¸€ä¸ªæ‰§è¡Œç­–ç•¥ï¼Œä¸æ˜¯ä¿¡å·ç­–ç•¥
2. æŒ‰æ—¶é—´å®šæœŸä¹°å…¥ï¼Œä¸è€ƒè™‘å¸‚åœºçŠ¶æ€
3. è¡¨ç°æ¥è¿‘ä¹°å…¥æŒæœ‰ï¼ˆ-1.65%ï¼‰

---

## ğŸ¯ å…³é”®å‘ç°

### 1. ç­–ç•¥è¡¨ç°ä¸å¸‚åœºç¯å¢ƒé«˜åº¦ç›¸å…³

| ç­–ç•¥ç±»å‹ | é€‚åˆå¸‚åœº | 2023å¹´è¡¨ç° |
|----------|----------|-----------|
| å‡å€¼å›å½’ | éœ‡è¡å¸‚åœº | âœ… æœ€ä½³ï¼ˆ92.18%ï¼‰ |
| åŠ¨é‡ | è¶‹åŠ¿å¸‚åœº | âŒ å·®ï¼ˆ-54.36%ï¼‰ |
| é«˜é¢‘åè½¬ | è¶‹åŠ¿å¸‚åœº | âŒ æå·®ï¼ˆ-98.52%ï¼‰ |
| æ‰§è¡Œç­–ç•¥ | ä»»ä½•å¸‚åœº | ä¸­ç­‰ï¼ˆ-2.97%ï¼‰ |

### 2. äº¤æ˜“é¢‘ç‡ä¸è¡¨ç°

| é¢‘ç‡ | äº¤æ˜“æ¬¡æ•° | ç´¯è®¡æ”¶ç›Š | ç»“è®º |
|------|----------|----------|------|
| ä½é¢‘ï¼ˆ<1000ï¼‰ | 966 | 92.18% | âœ… æœ€ä½³ |
| ä¸­é¢‘ï¼ˆ1000-5000ï¼‰ | 3,364 | -2.97% | ä¸­ç­‰ |
| é«˜é¢‘ï¼ˆ10000+ï¼‰ | 13,169 | -54.36% | è¾ƒå·® |
| è¶…é«˜é¢‘ï¼ˆ50000+ï¼‰ | 55,915 | -98.52% | æœ€å·® |

**ç»“è®ºï¼š**
- ä½é¢‘ç­–ç•¥è¡¨ç°æœ€å¥½
- é«˜é¢‘ç­–ç•¥è¢«äº¤æ˜“æˆæœ¬æ‹–ç´¯
- éœ€è¦è€ƒè™‘æ‰‹ç»­è´¹å’Œæ»‘ç‚¹

### 3. èƒœç‡ä¸å¤æ™®æ¯”ç‡

| ç­–ç•¥ | èƒœç‡ | å¤æ™®æ¯”ç‡ | å…³ç³» |
|------|------|----------|------|
| Enhanced Indexing | 60.76% | 8.11 | é«˜èƒœç‡+é«˜å¤æ™® âœ… |
| TWAP | 48.87% | -0.74 | ä½èƒœç‡+ä½å¤æ™® âš ï¸ |
| TopK | 47.57% | -3.63 | ä½èƒœç‡+ä½å¤æ™® âŒ |
| SBB | 43.41% | -21.26 | ä½èƒœç‡+æä½å¤æ™® âŒ |

**ç»“è®ºï¼š**
- èƒœç‡ > 55% æ˜¯ç¨³å®šç›ˆåˆ©çš„å…³é”®
- å¤æ™®æ¯”ç‡ > 1 æ˜¯å¯æ¥å—çš„ç­–ç•¥
- èƒœç‡ < 50% åŸºæœ¬æ— æ³•ç›ˆåˆ©

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. é’ˆå¯¹ Enhanced Indexing çš„ä¼˜åŒ–

**å½“å‰è¡¨ç°å·²ç»å¾ˆå¥½ï¼Œä½†ä»å¯ä¼˜åŒ–ï¼š**

```python
# ä¼˜åŒ–1ï¼šåŠ¨æ€è°ƒæ•´æ ‡å‡†å·®å€æ•°
# å¸‚åœºæ³¢åŠ¨å¤§æ—¶æ‰©å¤§å€æ•°ï¼Œæ³¢åŠ¨å°æ—¶ç¼©å°å€æ•°
volatility = df['std'] / df['ma']
df['dynamic_std_multiplier'] = 2 + (volatility * 5)

# ä¼˜åŒ–2ï¼šåŠ å…¥æˆäº¤é‡ç¡®è®¤
df['volume_ma'] = df['volume'].rolling(20).mean()
volume_filter = df['volume'] > df['volume_ma'] * 1.5

# åªåœ¨æˆäº¤é‡æ”¾å¤§æ—¶äº¤æ˜“
df.loc[volume_filter & (df['z_score'] < -2), 'position'] = 1
```

### 2. é’ˆå¯¹é«˜é¢‘ç­–ç•¥çš„ä¼˜åŒ–

**é™ä½äº¤æ˜“é¢‘ç‡ï¼š**

```python
# åŠ å…¥æŒä»“æ—¶é—´é™åˆ¶
min_hold_time = 60  # è‡³å°‘æŒæœ‰60åˆ†é’Ÿ
df['hold_time'] = df.groupby((df['position'] != df['position'].shift()).cumsum()).cumcount()

# æœªè¾¾åˆ°æœ€å°æŒä»“æ—¶é—´ä¸å˜æ›´ä»“ä½
df.loc[df['hold_time'] < min_hold_time, 'position'] = df['position'].shift(1)
```

### 3. ç»„åˆç­–ç•¥

**è¶‹åŠ¿ + å‡å€¼å›å½’ï¼š**

```python
# ç”¨ EMA åˆ¤æ–­è¶‹åŠ¿
df['ema'] = df['close'].ewm(span=50).mean()
df['trend'] = np.where(df['close'] > df['ema'], 1, -1)

# å‡å€¼å›å½’ä¿¡å·
df['z_score'] = (df['close'] - df['ma']) / df['std']
df['mean_revert_signal'] = np.where(df['z_score'] < -2, 1, -1)

# ç»„åˆï¼šåªåœ¨è¶‹åŠ¿æ–¹å‘è¿›è¡Œå‡å€¼å›å½’
df['position'] = df['mean_revert_signal'] * df['trend']
```

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `qlib_strategies_backtest_fixed.py` - ä¿®å¤ç‰ˆå›æµ‹è„šæœ¬
- `backtest_*.csv` - å„ç­–ç•¥è¯¦ç»†æ•°æ®

---

## ğŸš€ ä¸‹ä¸€æ­¥

æˆ‘å¯ä»¥å¸®ä½ ï¼š

1. **æµ‹è¯•ä¸åŒé¢‘ç‡**
   - Enhanced Indexing åœ¨ 5min, 15min, 60min çš„è¡¨ç°
   - å¯»æ‰¾æœ€ä¼˜é¢‘ç‡

2. **å‚æ•°ä¼˜åŒ–**
   - Enhanced Indexing çš„çª—å£ä¼˜åŒ–
   - å¯»æ‰¾æœ€ä¼˜å‚æ•°ç»„åˆ

3. **å®ç°æ–°ç­–ç•¥**
   - SuperTrend ç­–ç•¥
   - ç»„åˆç­–ç•¥
   - æœºå™¨å­¦ä¹ ç­–ç•¥

éœ€è¦å“ªä¸ªï¼Ÿ
