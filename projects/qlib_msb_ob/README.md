# Qlib MSB+OB 策略项目

基于 LuxAlgo Market Structure Break & OB Probability Toolkit 的 Qlib 实现

## 项目结构

```
qlib_msb_ob/
├── data/               # 数据文件
│   ├── RB9999_2023_60min.csv
│   ├── RB9999_2024_60min.csv
│   └── RB9999_2025_60min.csv
├── scripts/            # 数据准备和回测脚本
│   ├── prepare_data.py     # 数据准备脚本
│   ├── backtest_strategy.py # 回测脚本
│   └── review_strategy.py   # Code review 脚本
├── strategy/           # 策略实现
│   └── msb_ob_strategy.py   # MSB+OB 策略
├── reports/            # 回测报告
└── docs/               # 文档
```

## 策略说明

**核心逻辑**：
1. 识别市场结构突破（MSB）
2. 回溯寻找逆向K线作为订单块（OB）
3. 计算OB质量分数
4. 等待价格回调/反弹至OB区域入场
5. OB边界外设置止损
6. 基于OB宽度设置多目标止盈

**参数**：
- pivot_len: 7（枢轴点回看期）
- msb_zscore: 0.5（MSB动量阈值）
- ob_max_count: 10（最大活跃OB数）
- hpz_threshold: 80（高概率OB阈值）
- atr_multiplier: 1.0（ATR止损倍数）
- tp1_multiplier: 0.5（目标1：OB宽度×0.5）
- tp2_multiplier: 1.0（目标2：OB宽度×1.0）
- tp3_multiplier: 1.5（目标3：OB宽度×1.5）

---

## ⚠️ 重要经验教训

### 🎯 策略回测必须包含真实交易成本

**核心教训**：任何策略改进的回测，都必须包含完整的交易成本建模，否则会得到误导性的结论。

#### 案例对比：移动止盈策略的"假象"

**信号级测试（不含交易成本）**：
- 原始方案：24.77%收益，3.04%回撤
- 移动止盈：24.68%收益，2.17%回撤 ✅ **看似优秀**（回撤降低28.6%）

**真实交易成本测试**：
- 原始方案：-0.71%收益，1.04%回撤
- 移动止盈：-0.74%收益，1.15%回撤 ❌ **实际更差**（回撤增加10.6%）

**差异原因**：
- 移动止盈导致交易次数增加60%（151笔→241笔）
- 额外手续费634元（账户本金的0.63%）
- 激活率仅16.6%，大部分交易享受不到移动止盈优势

#### 📋 回测必须包含的成本项

| 成本类型 | 参数设置 | 说明 |
|---------|---------|------|
| **手续费** | 0.01%（开平各收） | 螺纹钢万一手续费 |
| **滑点** | 1 tick | 螺纹钢1元/吨 |
| **保证金** | 10% | 占用资金成本 |
| **仓位限制** | 单次30%，总计50% | 风控要求 |
| **合约乘数** | 10吨/手 | 螺纹钢标准 |

#### 🔧 推荐回测流程

1. **信号级测试**（初步筛选）
   - 快速验证逻辑
   - 但不做最终结论

2. **真实成本测试**（必须执行）
   - 使用 `RealisticBacktestEngine`
   - 包含所有交易成本
   - 验证资金占用和仓位限制

3. **对比分析**（关键步骤）
   - 计算交易次数变化
   - 分析成本占比
   - 评估改进的实际收益

#### 📝 代码实现参考

**真实回测引擎位置**：
- `strategies/v03_hybrid/realistic_backtest.py` - 原始方案真实回测
- `strategies/v03_hybrid/realistic_trailing_stop.py` - 移动止盈真实回测

**关键配置**：
```python
class TradingConfig:
    INITIAL_CAPITAL = 100_000.0      # 初始资金
    BASE_POSITION_VALUE = 50_000.0   # 单次开仓金额
    CONTRACT_SIZE = 10.0             # 合约乘数
    MARGIN_RATE = 0.10               # 保证金比例
    COMMISSION_RATE = 0.0001         # 手续费率
    SLIPPAGE_TICKS = 1               # 滑点
    MAX_MARGIN_RATIO = 0.5           # 最大保证金占用
```

#### 🎓 结论

**永远不要用信号级回测做最终决策！**

信号级回测只能用于：
- ✅ 快速验证策略逻辑
- ✅ 初步筛选参数
- ✅ 发现明显的代码错误

真实交易成本回测才能用于：
- ✅ 最终决策依据
- ✅ 实盘参数设置
- ✅ 风险评估

**记住**：交易成本是量化策略的隐形杀手，可能会完全逆转一个看似"优秀"的策略改进！
