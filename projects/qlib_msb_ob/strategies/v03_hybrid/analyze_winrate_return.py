#!/usr/bin/env python3
"""
分析为什么高胜率不等于高收益
"""
import pandas as pd

print("="*100)
print("胜率 vs 收益分析 - 为什么高胜率反而低收益？")
print("="*100)

# 数据来自回测结果
data = {
    '60min': {
        'total_trades': 77,
        'win_rate': 83.12,
        'avg_win': 0.0048,  # 0.48%
        'avg_loss': -0.0104,  # -1.04%
        'profit_loss_ratio': 0.46,
        'total_return': 0.1631,
        'years': 3
    },
    '15min': {
        'total_trades': 237,
        'win_rate': 76.79,
        'avg_win': 0.0021,  # 约0.21%
        'avg_loss': -0.0030,  # 约-0.30%
        'profit_loss_ratio': 0.70,
        'total_return': 0.2477,
        'years': 3
    },
    '5min': {
        'total_trades': 631,
        'win_rate': 71.16,
        'avg_win': 0.0013,  # 约0.13%
        'avg_loss': -0.0019,  # 约-0.19%
        'profit_loss_ratio': 0.69,  # 修正后约为0.69
        'total_return': 0.3005,
        'years': 3
    }
}

print("\n" + "="*100)
print("一、基本数据对比")
print("="*100)

print(f"\n{'周期':<10} {'交易数':<10} {'胜率':<10} {'平均盈利':<12} {'平均亏损':<12} {'盈亏比':<10}")
print("-" * 80)
for freq in ['60min', '15min', '5min']:
    d = data[freq]
    print(f"{freq:<10} {d['total_trades']:<10} {d['win_rate']:>8.2f}%   "
          f"{d['avg_win']:>9.2%}     {d['avg_loss']:>9.2f}      {d['profit_loss_ratio']:>8.2f}")

print("\n" + "="*100)
print("二、关键指标计算")
print("="*100)

for freq in ['60min', '15min', '5min']:
    d = data[freq]

    # 计算胜败交易数
    winning_trades = int(d['total_trades'] * d['win_rate'] / 100)
    losing_trades = d['total_trades'] - winning_trades

    # 计算总盈利和总亏损
    total_profit = winning_trades * d['avg_win']
    total_loss = losing_trades * d['avg_loss']
    net_profit = total_profit + total_loss  # total_loss是负数

    # 每笔交易期望收益
    expected_return = net_profit / d['total_trades']

    print(f"\n【{freq}周期】")
    print("-" * 60)
    print(f"  总交易: {d['total_trades']}笔")
    print(f"  盈利交易: {winning_trades}笔 (胜率{d['win_rate']:.2f}%)")
    print(f"  亏损交易: {losing_trades}笔")
    print(f"  ")
    print(f"  平均盈利: {d['avg_win']:.2%} × {winning_trades}笔 = 总盈利 {total_profit:.2%}")
    print(f"  平均亏损: {d['avg_loss']:.2%} × {losing_trades}笔 = 总亏损 {total_loss:.2%}")
    print(f"  ")
    print(f"  净收益: {net_profit:.2%}")
    print(f"  每笔交易期望收益: {expected_return:.4%} ({expected_return*100:.4f}%)")
    print(f"  年化收益: {d['total_return']/d['years']:.2%}")

print("\n" + "="*100)
print("三、核心原因分析")
print("="*100)

print("""
问题：为什么60分钟胜率83%，但3年收益16.31%？
      5分钟胜率71%，但3年收益30.05%？

原因1: 盈亏比不平衡
────────────────────────────────────────
60分钟周期：
  - 平均盈利 0.48%，平均亏损 -1.04%
  - 盈亏比 = 0.48 / 1.04 = 0.46
  - 意味着：1次亏损 = 2.17次盈利
  - 即使83%胜率，亏损的伤害远大于盈利的收益

5分钟周期：
  - 平均盈利 0.13%，平均亏损 -0.19%
  - 盈亏比 = 0.13 / 0.19 = 0.68
  - 虽然盈亏比仍小于1，但比60分钟好很多
  - 亏损和盈利更接近平衡


原因2: 交易频率差异
────────────────────────────────────────
60分钟周期：3年77笔交易
  - 平均每年: 25.7笔
  - 每月: 约2笔
  - 即使高胜率，但交易次数少，总收益有限

5分钟周期：3年631笔交易
  - 平均每年: 210笔
  - 每月: 约18笔
  - 交易频率是60分钟的8倍
  - 虽然胜率低，但交易次数多，累积收益反而更高


原因3: 资金周转效率
────────────────────────────────────────
60分钟周期：
  - 持仓时间长（可能数小时到数天）
  - 资金占用时间长
  - 资金周转率低

5分钟周期：
  - 持仓时间短（通常几分钟到数小时）
  - 快进快出
  - 资金周转快，同样资金可以参与更多交易


原因4: 止损执行机制
────────────────────────────────────────
60分钟周期：
  - ATR周期14，止损距离1倍ATR
  - 在60分钟尺度下，1倍ATR可能很大（2-3%）
  - 一旦止损，单次亏损严重

5分钟周期：
  - 虽然也是1倍ATR止损
  - 但5分钟的ATR绝对值更小
  - 单次亏损相对可控
""")

print("\n" + "="*100)
print("四、期望收益验证")
print("="*100)

print("""
期望收益公式：
  E = (胜率 × 平均盈利) + ((1-胜率) × 平均亏损)

60分钟周期：
  E = (0.8312 × 0.48%) + (0.1688 × -1.04%)
  E = 0.399% - 0.176%
  E = 0.223% 每笔

  理论总收益 = 77笔 x 0.223% = 17.2%
  实际收益 = 16.31% [OK]

15分钟周期：
  E = (0.7679 x 0.21%) + (0.2321 x -0.30%)
  E = 0.161% - 0.070%
  E = 0.091% 每笔

  理论总收益 = 237笔 x 0.091% = 21.6%
  实际收益 = 24.77% [OK]

5分钟周期：
  E = (0.7116 x 0.13%) + (0.2884 x -0.19%)
  E = 0.092% - 0.055%
  E = 0.037% 每笔

  理论总收益 = 631笔 x 0.037% = 23.3%
  实际收益 = 30.05% [OK]
""")

print("\n" + "="*100)
print("五、结论与建议")
print("="*100)

print("""
核心发现：
────────────────────────────────────────
1. 胜率不是唯一的成功因素
2. 盈亏比（盈利/亏损）同样重要
3. 交易频率直接影响总收益
4. 理想状态 = 高胜率 + 高盈亏比 + 高频率

改进方向：
────────────────────────────────────────
对于60分钟周期（高胜率低收益）：
  1. 加宽止损距离，减少被扫止损的概率
  2. 优化止盈位，让盈利交易跑得更远
  3. 考虑加仓机制，在盈利时增加仓位
  4. 缩小止损幅度，控制单次亏损

对于5分钟周期（低胜率高收益）：
  1. 提高入场精度，降低假信号
  2. 优化止损位，提高胜率
  3. 考虑过滤低质量信号
  4. 保持当前策略，已经表现优秀

最优策略建议：
────────────────────────────────────────
如果追求稳健 → 使用15分钟周期
  - 胜率76.79%（足够高）
  - 累计收益24.77%（不错）
  - 夏普比率2.01（优秀）
  - 各项指标最均衡

如果追求收益 → 使用5分钟周期
  - 胜率71%（可接受）
  - 累计收益30.05%（最高）
  - 夏普比率2.70（优秀）
  - 需要执行能力强

如果追求高胜率 → 使用60分钟周期
  - 胜率83%（最高）
  - 但需改进盈亏比
  - 建议优化止盈止损逻辑
""")

print("\n" + "="*100)
