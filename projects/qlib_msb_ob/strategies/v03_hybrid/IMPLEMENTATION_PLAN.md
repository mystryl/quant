# V03: 混合策略 - 实施计划

## 策略概述
- **版本**: V03
- **名称**: 混合策略（Hybrid Strategy）
- **创建日期**: 2025-02-18
- **目的**: 结合V02简化入场和V01高级出场，创建最优MSB+OB策略

## 策略特点
- **入场**: 采用V02的简化入场规则（MSB后反向K线入场）
- **出场**: 保留V01的ATR分层止盈和OB出场逻辑
- **混合**: 取两者之长，平衡交易频率和盈利能力

## 实现目标
1. 简化入场规则，提高交易频率
2. 保留高级出场逻辑，最大化单笔收益
3. 实现胜率和收益率的最佳平衡
4. 作为当前最优版本进行实盘部署

## 入场规则（继承V02）

### MSB信号检测
1. **看涨MSB**:
   - 价格突破最近的高点枢轴点（pivot_high）
   - 前一根K线收盘价 ≤ 枢轴点
   - 当前根K线收盘价 > 枢轴点
   - 动量Z-Score > 0.3

2. **看跌MSB**:
   - 价格突破最近的低点枢轴点（pivot_low）
   - 前一根K线收盘价 ≥ 枢轴点
   - 当前根K线收盘价 < 枢轴点
   - 动量Z-Score < -0.3

### 入场时机
- **做多**: MSB看涨信号后，下一根K线如果是阴线（收盘<开盘），则开多
- **做空**: MSB看跌信号后，下一根K线如果是阳线（收盘>开盘），则开空

## 出场规则（继承V01）

### 止损规则
- **止损位**: 入场价 +/- 1倍ATR（14周期）
- **触发**: 价格触及止损位立即平仓

### 分层止盈（TP1/TP2/TP3）
| 止盈位 | 距离 | 说明 |
|--------|------|------|
| TP1 | 0.5倍ATR | 第一目标，部分平仓 |
| TP2 | 1.0倍ATR | 第二目标，部分平仓 |
| TP3 | 1.5倍ATR | 第三目标，全部平仓 |

### OB出场
- 当检测到Order Block被价格穿越失效时，提前平仓
- 作为额外的风险控制机制

### 止盈触发顺序
1. 价格到达TP1 → 平仓1/3仓位
2. 价格到达TP2 → 再平仓1/3仓位
3. 价格到达TP3 → 平仓剩余1/3仓位
4. 期间如果OB失效 → 立即平仓剩余仓位

## 风险管理

### 止损机制
- **初始止损**: 入场价 +/- 1倍ATR
- **移动止损**: 可选，价格有利时跟踪止损

### 仓位管理
- **初始仓位**: 等权重分配
- **分层止盈**: 自动调整仓位大小

### 风险暴露
- 单笔最大风险：1倍ATR
- 总体风险：由资金管理策略决定

## 回测参数
- **数据周期**: 60分钟、15分钟、5分钟
- **回测期间**: 2023-2025年
- **交易品种**: RB9999（螺纹钢主力合约）

### 关键参数
| 参数 | 值 | 说明 |
|------|-----|------|
| pivot_len | 7 | 枢轴点检测窗口 |
| msb_zscore | 0.3 | MSB动量阈值 |
| atr_period | 14 | ATR计算周期 |
| atr_multiplier | 1.0 | ATR止损倍数 |
| tp1_multiplier | 0.5 | 第一止盈位（ATR倍数） |
| tp2_multiplier | 1.0 | 第二止盈位（ATR倍数） |
| tp3_multiplier | 1.5 | 第三止盈位（ATR倍数） |

## 回测结果

### 60分钟周期
| 年份 | MSB数 | OB数 | 交易数 | 胜率 | 累计收益 | 最大回撤 | 夏普比率 |
|------|------|-----|--------|------|---------|---------|---------|
| 2023 | 82 | 82 | 29 | 86.21% | +0.09% | -0.03% | - |
| 2024 | 71 | 71 | 17 | 82.35% | +0.04% | -0.01% | - |
| 2025 | 78 | 78 | 31 | 80.65% | +0.03% | -0.02% | - |
| **合计** | **231** | **231** | **77** | **83.07%** | **+0.16%** | **-0.03%** | **1.17** |

### 15分钟周期
| 年份 | MSB数 | OB数 | 交易数 | 胜率 | 累计收益 | 最大回撤 | 夏普比率 |
|------|------|-----|--------|------|---------|---------|---------|
| 2023 | 228 | 228 | 86 | 76.74% | +0.11% | -0.02% | - |
| 2024 | 203 | 203 | 75 | 78.67% | +0.08% | -0.03% | - |
| 2025 | 216 | 216 | 76 | 75.00% | +0.06% | -0.01% | - |
| **合计** | **647** | **647** | **237** | **76.80%** | **+0.25%** | **-0.03%** | **2.01** |

### 5分钟周期
| 年份 | MSB数 | OB数 | 交易数 | 胜率 | 累计收益 | 最大回撤 | 夏普比率 |
|------|------|-----|--------|------|---------|---------|---------|
| 2023 | 643 | 642 | 227 | 66.96% | +0.05% | -0.02% | - |
| 2024 | 585 | 584 | 201 | 75.62% | +0.14% | -0.02% | - |
| 2025 | 601 | 598 | 203 | 71.43% | +0.10% | -0.01% | - |
| **合计** | **1829** | **1824** | **631** | **71.34%** | **+0.30%** | **-0.02%** | **2.70** |

### 综合对比

| 周期 | 交易数 | 胜率 | 累计收益 | 最大回撤 | 夏普比率 |
|------|-------|------|---------|---------|---------|
| 60min | 77 | 83.07% | +0.16% | -0.03% | 1.17 |
| 15min | 237 | 76.80% | +0.25% | -0.03% | 2.01 |
| 5min | 631 | 71.34% | +0.30% | -0.02% | 2.70 |

**关键发现**:
- 胜率优秀：71-83%（远高于V02的61-64%）
- 夏普比率优秀：1.17-2.70
- 短周期交易频率高，收益更好
- 最大回撤控制良好（≤0.03%）

## 代码结构

### 主要文件
- `strat_v03_hybrid.py`: 策略主文件

### 主要类和函数

#### HybridMSBOBStrategy类
```python
class HybridMSBOBStrategy:
    def __init__(self, pivot_len, msb_zscore, atr_period, ...):
        # 初始化参数

    def calculate_momentum_z(self, close, window=50):
        # 计算动量Z-Score

    def detect_pivots(self, high, low, pivot_len=7):
        # 检测枢轴点

    def detect_msb(self):
        # 检测MSB信号

    def identify_order_blocks(self):
        # 识别Order Block

    def generate_signals(self):
        # 生成交易信号（简化入场）

    def run_strategy(self, df):
        # 运行完整策略
```

#### 辅助函数
- `_identify_trades()`: 识别完整交易（用于正确计算胜率）
- `calculate_metrics()`: 计算回测指标（已修正）
- `load_data()`: 加载数据
- `run_backtest_for_year()`: 单年回测
- `main()`: 主程序入口

### 关键逻辑流程
```python
1. 计算动量Z-Score
2. 检测枢轴点（pivot_high/pivot_low）
3. 检测MSB信号（突破枢轴点 + 动量条件）
4. 识别Order Block（在MSB前的强K线）
5. 生成入场信号：
   - 如果MSB看涨 → 等待阴线开多
   - 如果MSB看跌 → 等待阳线开空
6. 设置止损和止盈位：
   - 止损: 入场价 +/- 1倍ATR
   - TP1: 入场价 +/- 0.5倍ATR
   - TP2: 入场价 +/- 1.0倍ATR
   - TP3: 入场价 +/- 1.5倍ATR
7. 监控OB失效，提前平仓
8. 分层止盈执行
```

## 优化方向

### 当前优点
1. ✅ **胜率优秀**: 71-83%，远超V02
2. ✅ **夏普比率高**: 1.17-2.70，风险调整后收益好
3. ✅ **出场逻辑完善**: ATR分层止盈 + OB保护
4. ✅ **风险控制好**: 最大回撤≤0.03%
5. ✅ **交易频率适中**: 每年77-631笔，取决于周期

### 当前缺点
1. ⚠️ 每笔平均收益较小（约0.002-0.0005）
2. ⚠️ 累计收益较低（3年仅0.16-0.30%）
3. ⚠️ OB追踪可能增加计算开销

### 改进建议

#### 高优先级
1. **仓位管理优化**:
   - 根据信号强度调整仓位（强信号2倍，弱信号1倍）
   - 考虑金字塔加仓（价格有利时加仓）

2. **移动止损**:
   - 当价格到达TP1后，将止损移至入场价（保本）
   - 当价格到达TP2后，将止损移至TP1（锁定部分利润）

3. **参数优化**:
   - 测试不同的ATR倍数组合
   - 优化msb_zscore阈值平衡胜率和频率

#### 中优先级
4. **出场优化**:
   - 考虑增加TP4（2.0倍ATR）用于大趋势
   - 根据市场波动率动态调整止盈位

5. **入场优化**:
   - 考虑在多个反向K线中选择最优入场价
   - 结合成交量确认入场时机

6. **多周期过滤**:
   - 只在高周期的MSB方向上交易
   - 提高信号质量和胜率

#### 低优先级
7. **机器学习增强**:
   - 使用ML预测MSB的成功概率
   - 动态调整仓位和止盈止损

8. **市场状态识别**:
   - 识别趋势/震荡市场
   - 在趋势市场使用策略，震荡市场停止交易

## 适用场景

### 最佳适用
- 需要高胜率的交易场景
- 趋势跟随策略
- 机构资金（低风险偏好）
- 需要稳定现金流策略

### 风险提示
- 单笔收益较小，需要较大仓位或杠杆才能获得显著收益
- 策略在强趋势中可能过早离场（分层止盈）
- 需要良好的流动性执行分层止盈

## 版本对比

| 特性 | V01原版 | V02简化 | V03混合 |
|------|---------|---------|---------|
| 入场规则 | MSB即时入场 | MSB+反向K线 | MSB+反向K线 ✓ |
| 出场规则 | OB+ATR分层 | 固定3根K线 | ATR分层 ✓ |
| 止损 | 有（1倍ATR） | 无 | 有（1倍ATR） ✓ |
| OB出场 | 有 | 无 | 有 ✓ |
| 交易频率（60min） | 极低（0笔） | 中等（76笔） | 中等（77笔） ✓ |
| 胜率（60min） | N/A | 62.73% | **83.07%** ✓✓✓ |
| 夏普（60min） | N/A | 0.90 | **1.17** ✓ |
| 复杂度 | 高 | 低 | 中 |
| **推荐度** | ❌ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

## 实施建议

### 实盘部署前
1. ✅ 在历史数据上验证策略稳定性（已完成）
2. ✅ 在模拟账户中测试至少3个月
3. ✅ 准备风险控制预案
4. ✅ 测试分层止盈的执行逻辑

### 实盘部署
1. **第一阶段**（1-2周）:
   - 使用最小仓位测试
   - 验证信号生成和执行逻辑
   - 检查滑点和手续费影响

2. **第二阶段**（1个月）:
   - 逐步放大至正常仓位
   - 严格记录每笔交易
   - 监控胜率和收益是否符合预期

3. **第三阶段**（持续）:
   - 正常运行
   - 定期检查策略参数
   - 根据市场变化调整

### 监控指标
- 每日/每周交易次数
- 胜率变化趋势（目标：>75%）
- 最大连续亏损次数（警告：>5次）
- 平均持仓时间
- TP1/TP2/TP3触发比例
- OB出场触发次数
- 实际滑点和手续费占比

### 终止条件
如果出现以下情况，暂停策略并重新评估：
- 连续亏损次数 > 10次
- 月度胜率 < 60%
- 最大回撤超过预期2倍
- 市场环境发生重大变化

## 后续发展方向

### V04计划（趋势增强版）
1. 添加趋势识别指标（ADX/EMA）
2. 只在趋势方向交易
3. 大趋势中延长持仓时间

### V05计划（多品种版）
1. 扩展至其他期货品种
2. 品种间相关性分析
3. 分散投资组合

### V06计划（期权增强版）
1. 使用期权替代期货
2. 利用期权的不对称收益特性
3. 降低最大回撤

## 文件位置
- 策略文件: `strategies/v03_hybrid/strat_v03_hybrid.py`
- 回测报告: `strategies/v03_hybrid/report_v03_hybrid.csv`
- 实施计划: `strategies/v03_hybrid/IMPLEMENTATION_PLAN.md`

## 总结
V03混合策略是当前最优版本，成功结合了V02的简化入场和V01的高级出场：
- **胜率**: 71-83%（优秀）
- **夏普比率**: 1.17-2.70（优秀）
- **风险控制**: 最大回撤≤0.03%（优秀）
- **推荐指数**: ⭐⭐⭐⭐⭐

建议优先将V03策略投入实盘测试。
