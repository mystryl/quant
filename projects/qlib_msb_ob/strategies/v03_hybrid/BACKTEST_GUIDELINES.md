# V03混合策略回测指南

## 📋 回测标准流程

### 第一阶段：信号级回测（快速验证）

**目的**：快速验证策略逻辑，初步筛选参数

**使用文件**：
- `strat_v03_hybrid.py` - 原始策略
- `strat_v03_atr_partial_exit.py` - ATR分层止盈
- `strat_v03_trailing_stop.py` - 移动止盈

**运行方式**：
```bash
python strategies/v03_hybrid/strat_v03_hybrid.py
```

**特点**：
- ✅ 快速执行（几秒钟）
- ✅ 清晰展示信号逻辑
- ❌ **不包含任何交易成本**
- ❌ **不做最终决策依据**

**可获取指标**：
- 信号数量
- 基本盈亏比
- 信号质量分布

---

### 第二阶段：真实成本回测（必须执行）

**目的**：在真实交易环境下验证策略表现

**使用文件**：
- `realistic_backtest.py` - 原始方案真实回测
- `realistic_trailing_stop.py` - 移动止盈真实回测

**运行方式**：
```bash
python strategies/v03_hybrid/realistic_backtest.py
```

**特点**：
- ✅ 包含完整交易成本
- ✅ 模拟真实仓位管理
- ✅ 考虑保证金占用
- ✅ **用于最终决策**

**真实成本构成**：

| 成本项 | 参数 | 影响 |
|--------|------|------|
| 手续费 | 0.01%×2（开平） | 每笔交易固定成本 |
| 滑点 | 1 tick | 与交易次数正相关 |
| 保证金 | 10% | 限制最大仓位 |
| 仓位限制 | 30%/50% | 影响资金利用率 |

**可获取指标**：
- 真实收益率（扣除所有费用）
- 最大回撤
- 夏普比率
- 胜率
- 总手续费占比
- 平均持仓时间
- 保证金占用情况

---

## ⚠️ 常见错误与教训

### 错误1：只做信号级回测就下结论

**案例**：移动止盈策略测试

**信号级结果**：
```
原始方案：24.77%收益，3.04%回撤
移动止盈：24.68%收益，2.17%回撤
结论：移动止盈优秀（回撤降低28.6%）
```

**真实成本级结果**：
```
原始方案：-0.71%收益，1.04%回撤
移动止盈：-0.74%收益，1.15%回撤
结论：移动止盈更差（回撤增加10.6%）
```

**原因分析**：
- 移动止盈导致交易次数增加60%（151笔→241笔）
- 额外手续费634元
- 激活率仅16.6%，大部分交易享受不到优势

**教训**：信号级回测的结果可能与真实情况完全相反！

### 错误2：忽略交易次数的影响

**问题**：策略A收益相同，但交易次数是策略B的2倍

**后果**：
- 手续费翻倍
- 滑点成本翻倍
- 最终收益可能变负

**正确做法**：
1. 比较收益率时，必须同时看交易次数
2. 计算手续费占比（应<1%）
3. 优先选择交易次数少的方案

### 错误3：不考虑资金占用

**问题**：策略满仓操作，看似收益高

**后果**：
- 实盘可能资金不足
- 无法按计划开仓
- 回测结果不可实现

**正确做法**：
1. 设置合理的仓位限制（单次≤30%，总计≤50%）
2. 记录保证金占用情况
3. 确保策略在限制条件下运行

---

## 📊 回测报告模板

### 必需指标

**基础指标**：
```
总收益率：X%
最大回撤：X%
夏普比率：X
胜率：X%
总交易数：X笔
```

**成本分析**：
```
总手续费：X元（占账户X%）
总滑点成本：X元
平均每笔成本：X元
```

**风险指标**：
```
最大单笔亏损：X元（占账户X%）
最大连续亏损：X笔
保证金平均占用：X%
```

**效率指标**：
```
年化收益：X%
收益/回撤比：X
平均持仓时间：X小时
```

### 对比分析表格

| 维度 | 方案A | 方案B | 变化 |
|------|-------|-------|------|
| 收益率 | X% | X% | ±X% |
| 回撤 | X% | X% | ±X% |
| 交易数 | X笔 | X笔 | ±X% |
| 手续费占比 | X% | X% | ±X% |
| 胜率 | X% | X% | ±X% |
| 结论 | | | ✅/❌ |

---

## 🔧 回测工具使用

### 1. 运行原始策略回测

```bash
# 信号级（快速验证）
python strategies/v03_hybrid/strat_v03_hybrid.py

# 真实成本级（最终决策）
python strategies/v03_hybrid/realistic_backtest.py
```

### 2. 对比多个方案

```bash
# 方案对比（原始 vs ATR分层 vs 移动止盈）
python strategies/v03_hybrid/compare_solutions.py
```

### 3. 参数优化

```bash
# 15分钟周期参数优化
python strategies/v03_hybrid/optimization/optimize_15min.py
```

### 4. 查看详细交易记录

回测结果保存在：
```
strategies/v03_hybrid/realistic_results/
├── trades_2023_15min.csv      # 2023年交易记录
├── trades_2024_15min.csv      # 2024年交易记录
├── trades_2025_15min.csv      # 2025年交易记录
└── summary.csv                # 汇总报告
```

---

## ✅ 回测检查清单

在回测完成后，确认以下各项：

### 数据质量
- [ ] 数据时间范围正确（2023-2025）
- [ ] 数据周期正确（5min/15min/60min）
- [ ] 无缺失值或异常值

### 成本设置
- [ ] 手续费率：0.01%（开平各收）
- [ ] 滑点：1 tick
- [ ] 保证金：10%
- [ ] 合约乘数：10

### 风控设置
- [ ] 单次开仓≤30%
- [ ] 最大持仓≤50%
- [ ] 止损距离合理

### 结果分析
- [ ] 交易次数合理（不过多）
- [ ] 手续费占比<1%
- [ ] 最大回撤可接受
- [ ] 收益/回撤比>2
- [ ] 夏普比率>1

### 对比验证
- [ ] 信号级 vs 真实成本级
- [ ] 不同周期对比
- [ ] 不同年份对比

---

## 🎯 决策标准

### 策略接受标准

**必须满足**：
- ✅ 3年总收益率 > 0
- ✅ 最大回撤 < 3%
- ✅ 手续费占比 < 1%
- ✅ 夏普比率 > 0.5

**加分项**：
- ⭐ 收益/回撤比 > 2
- ⭐ 胜率 > 65%
- ⭐ 年化收益 > 5%
- ⭐ 最大连续亏损 < 5笔

### 策略拒绝标准

**任一条件即拒绝**：
- ❌ 3年总收益 < 0
- ❌ 最大回撤 > 5%
- ❌ 手续费占比 > 2%
- ❌ 交易次数 > 300笔/3年
- ❌ 最大单笔亏损 > 3%

---

## 📚 参考文档

- [主项目README](../../README.md)
- [V03实现计划](IMPLEMENTATION_PLAN.md)
- [方案对比报告](SOLUTION_COMPARISON_REPORT.md)
- [参数优化报告](optimization/15MIN_OPTIMIZATION_FINAL_REPORT.md)

---

**最后更新**：2026-02-18
**版本**：1.0
**维护者**：Quant Team
