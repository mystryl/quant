# Qlib 数据加载器与重采样完整指南

## 一、Qlib 数据加载器详解

### 1.1 数据加载器是什么？

Qlib 的数据加载器是一个分层的数据访问系统，主要组件包括：

```
D 接口 (用户层)
    ↓
DataProvider (数据提供者层)
    ↓
LocalDataProvider (本地文件系统)
    ↓
文件存储 (实际数据文件)
```

**核心特点：**
- 统一的数据访问接口 `D.features()`
- 支持多种数据源（本地、数据库、API）
- 自动频率转换和重采样
- 高效的数据缓存机制

### 1.2 数据结构要求

Qlib 要求严格的目录结构：

```
qlib_data/
├── calendars/              # 交易日历文件
│   ├── 1min.txt           # 每行一个时间点
│   ├── 5min.txt
│   ├── 15min.txt
│   ├── 60min.txt
│   └── day.txt
│
└── instruments/            # 合约数据
    ├── 1min/             # 1分钟数据
    │   ├── $open/        # 开盘价
    │   │   ├── RB9999.XSGE.csv
    │   │   └── ...
    │   ├── $high/        # 最高价
    │   ├── $low/         # 最低价
    │   ├── $close/       # 收盘价
    │   ├── $volume/      # 成交量
    │   ├── $amount/      # 成交额
    │   ├── $vwap/        # 成交均价
    │   └── $open_interest/ # 持仓量
    │
    ├── 5min/             # 5分钟数据（可选）
    ├── 15min/            # 15分钟数据（可选）
    ├── 60min/            # 60分钟数据（可选）
    └── day/              # 日线数据（可选）
```

**关键规则：**
1. 每个频率一个目录
2. 每个特征一个子目录
3. 每个合约一个 CSV 文件
4. 每个文件只包含一列数据（特征值）

### 1.3 数据文件格式

每个 CSV 文件的格式：

```csv
datetime,feature_name
2023-01-03 09:01:00,4069.0
2023-01-03 09:02:00,4056.0
2023-01-03 09:03:00,4052.0
...
```

**要求：**
- 第一列：datetime 索引
- 第二列：特征值
- 列名可以是任意名称（值会被使用）
- 不能有多列

## 二、Qlib 重采样机制

### 2.1 重采样方式

Qlib 支持两种重采样方式：

#### 方式一：预处理重采样（推荐）

**优点：**
- 速度快，数据一致性好
- 回测时无需等待重采样
- 可以验证重采样结果

**缺点：**
- 需要额外存储空间
- 需要提前生成所有频率的数据

**实现：**
```bash
# 运行重采样脚本
python3 resample_data.py
```

#### 方式二：运行时重采样

**优点：**
- 节省存储空间
- 只生成需要的频率

**缺点：**
- 速度较慢
- 每次回测都需要重采样

### 2.2 重采样规则

| 字段 | 重采样规则 | 说明 |
|------|-----------|------|
| open | first | 该时间段的第一个开盘价 |
| high | max | 该时间段的最高价 |
| low | min | 该时间段的最低价 |
| close | last | 该时间段的最后一个收盘价 |
| volume | sum | 该时间段的成交量之和 |
| amount | sum | 该时间段的成交额之和 |
| vwap | amount/volume | 重新计算成交均价 |
| open_interest | last | 该时间段最后一个持仓量 |

### 2.3 重采样频率支持

常见频率：
- **1min**: 1分钟 K线
- **5min**: 5分钟 K线
- **15min**: 15分钟 K线
- **30min**: 30分钟 K线
- **60min**: 1小时 K线
- **day**: 日线
- **week**: 周线
- **month**: 月线

## 三、实际应用案例

### 3.1 重采样脚本使用

```bash
# 1. 运行重采样脚本
cd /mnt/d/quant/qlib_backtest
python3 resample_data.py

# 2. 检查生成的数据
ls -lh qlib_data_multi_freq/instruments/

# 3. 验证数据质量
python3 -c "
import pandas as pd
for freq in ['5min', '15min', '60min']:
    df = pd.read_csv(f'qlib_data_multi_freq/instruments/{freq}/\$close/RB9999.XSGE.csv',
                     index_col=0, parse_dates=True)
    print(f'{freq}: {len(df)} 行')
"
```

### 3.2 多频率回测

```bash
# 运行多频率回测
python3 multi_freq_backtest.py
```

**输出文件：**
- `backtest_1min.csv`: 1分钟回测详细数据
- `backtest_5min.csv`: 5分钟回测详细数据
- `backtest_15min.csv`: 15分钟回测详细数据
- `backtest_60min.csv`: 60分钟回测详细数据
- `multi_freq_comparison.png`: 对比图表

## 四、回测结果对比分析

### 4.1 2023年螺纹钢回测结果

| 频率 | 交易次数 | 累计收益 | 年化收益 | 最大回撤 | 夏普比率 | 胜率 |
|------|----------|----------|----------|----------|----------|------|
| 1min | 9,668 | **92.18%** | **61.19%** | 2.25% | **8.11** | 60.76% |
| 5min | 2,046 | 10.84% | 7.38% | 2.82% | 1.37 | 56.41% |
| 15min | 709 | -2.52% | -1.58% | 5.99% | -0.37 | 50.16% |
| 60min | 225 | -9.15% | -4.42% | 10.48% | -1.35 | 41.44% |

### 4.2 关键发现

**1. 频率越低，效果越好**
- 1分钟：表现最佳，累计收益 92.18%
- 5分钟：表现良好，累计收益 10.84%
- 15分钟、60分钟：表现较差，出现亏损

**2. 交易次数与收益的关系**
- 1分钟：高频交易，捕捉微小波动
- 5分钟：中频交易，平衡收益和成本
- 15分钟、60分钟：低频交易，错过趋势机会

**3. 风险收益比**
- 1分钟：高收益低风险（夏普比率 8.11）
- 5分钟：中等收益中等风险
- 15分钟、60分钟：低收益高风险

### 4.3 为什么低频率效果差？

**布林带策略的特点：**
1. 均值回归策略在震荡市场有效
2. 需要快速进出捕捉短期波动
3. 在趋势市场容易亏损

**低频率的劣势：**
1. 反应速度慢，错过最佳进出点
2. 单笔交易风险大
3. 止损止损困难

**高频率的优势：**
1. 反应迅速，及时止损
2. 分散风险，单笔影响小
3. 捕捉微小波动，积少成多

## 五、实用建议

### 5.1 选择合适的频率

**高频（1-5分钟）：**
- 适合：日内交易、均值回归策略
- 要求：低延迟、低手续费
- 风险：交易次数多，滑点影响大

**中频（15-30分钟）：**
- 适合：波段交易、趋势跟随策略
- 要求：适中延迟、适中手续费
- 风险：中等交易次数，中等滑点

**低频（60分钟-日线）：**
- 适合：长线投资、基本面分析
- 要求：高延迟、高手续费
- 风险：交易次数少，单笔风险大

### 5.2 策略优化建议

**针对不同频率调整参数：**

```python
# 1分钟：快速反应
window = 20
std_multiplier = 1.5

# 5分钟：平衡
window = 20
std_multiplier = 2.0

# 15分钟：稳健
window = 30
std_multiplier = 2.5

# 60分钟：保守
window = 50
std_multiplier = 3.0
```

**加入止损机制：**
```python
# 设置最大亏损
max_loss = 0.02  # 2%

# 检查是否触发止损
if current_loss > max_loss:
    close_position()
```

**仓位管理：**
```python
# 根据信号强度调整仓位
if signal_strength > 0.8:
    position_size = 1.0  # 满仓
elif signal_strength > 0.5:
    position_size = 0.5  # 半仓
else:
    position_size = 0.2  # 轻仓
```

### 5.3 成本考虑

**实际交易成本：**
- 手续费：每笔交易 0.01%~0.1%
- 滑点：每笔交易 0.01%~0.05%
- 冲击成本：大额交易额外成本

**成本影响示例：**

| 频率 | 交易次数 | 手续费（0.05%） | 总成本 |
|------|----------|----------------|--------|
| 1min | 9,668 | 9,668 × 0.05% | 4.83% |
| 5min | 2,046 | 2,046 × 0.05% | 1.02% |
| 15min | 709 | 709 × 0.05% | 0.35% |
| 60min | 225 | 225 × 0.05% | 0.11% |

**结论：** 高频交易虽然收益高，但成本也高，需要综合考虑。

## 六、工具和脚本

### 6.1 可用脚本

```
/mnt/d/quant/qlib_backtest/
├── resample_data.py              # 数据重采样脚本
├── multi_freq_backtest.py        # 多频率回测脚本
├── backtest_direct.py            # 单频率回测脚本
└── qlib_data_loader_explained.py # 数据加载器说明
```

### 6.2 快速开始

```bash
# 1. 重采样数据
python3 resample_data.py

# 2. 多频率回测
python3 multi_freq_backtest.py

# 3. 查看结果
cat backtest_1min.csv | head -20
```

## 七、常见问题

### Q1: 为什么 1分钟回测结果这么好？

**A:**
- 布林带均值回归策略在短期波动中有效
- 高频交易能够快速止损
- 2023年螺纹钢市场适合此策略
- **注意：** 回测结果不代表未来表现

### Q2: 可以直接用 qlib 的数据加载器吗？

**A:**
- 可以，但需要严格按照 qlib 的数据格式准备数据
- 我们尝试了多次，数据加载仍有问题
- 建议直接使用 pandas 读取数据，更灵活
- 如果需要，可以继续调试 qlib 数据加载器

### Q3: 如何选择合适的频率？

**A:**
- 考虑策略类型：均值回归适合高频，趋势跟随适合低频
- 考虑交易成本：高频交易成本高
- 考虑市场特性：不同市场不同频率表现不同
- **建议：** 先用历史数据测试不同频率，选择最优

### Q4: 如何优化策略？

**A:**
1. 调整参数（窗口、标准差倍数）
2. 加入止损止盈
3. 优化仓位管理
4. 增加过滤条件（趋势确认、成交量确认）
5. 组合多个信号

## 八、总结

### 核心要点

1. **Qlib 数据加载器**：分层架构，需要严格的数据格式
2. **重采样机制**：支持预处理和运行时两种方式
3. **频率选择**：策略效果与频率密切相关
4. **成本考虑**：高频交易成本高，需要综合评估
5. **策略优化**：根据频率调整参数和风控

### 下一步建议

1. 测试更多频率组合
2. 优化策略参数
3. 加入风险管理
4. 考虑多因子策略
5. 进行更长时间的回测

---

**文档版本**: v1.0
**创建时间**: 2025-02-15
**最后更新**: 2025-02-15
