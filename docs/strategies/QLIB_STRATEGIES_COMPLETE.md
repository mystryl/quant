# Qlib 内置策略详细解释与回测结果

## 一、策略分类

Qlib 的策略分为两大类：

### 1. 信号策略 (Signal Strategy)

**特点：**
- 基于预测信号或因子得分生成交易决策
- 需要外部的预测模型提供信号
- 适合多资产组合管理

**主要策略：**
- `TopKDropoutStrategy` - TopK 丢弃策略
- `EnhancedIndexingStrategy` - 增强指数策略
- `SoftTopkStrategy` - 软 TopK 策略

### 2. 规则策略 (Rule Strategy)

**特点：**
- 基于预定义规则生成交易信号
- 不需要外部预测模型
- 适合单资产技术指标交易

**主要策略：**
- `SBBStrategyBase` - SBB 策略基类
- `SBBStrategyEMA` - 带 EMA 的 SBB 策略
- `TWAPStrategy` - TWAP 策略

---

## 二、策略详解

### 信号策略

#### 1. TopK Strategy（TopK 策略）

**原理：**
```
1. 计算所有资产的预测收益或因子得分
2. 按得分从高到低排序
3. 选择得分最高的 K 个资产
4. 等权重或按得分权重分配资金
```

**适用场景：**
- 多资产组合管理
- 有预测模型给出因子得分
- 想要捕捉表现最好的资产

**参数：**
- `topk`: 选择的资产数量（默认 50）
- `n_drop`: 每天卖出的资产数量（默认 5）

**优点：**
- ✅ 简单直观，易于理解
- ✅ 能够捕捉表现最好的资产
- ✅ 适合大规模资产池

**缺点：**
- ❌ 依赖外部预测模型
- ❌ 换手率高（每天买卖）
- ❌ 忽略风险控制

---

#### 2. Enhanced Indexing Strategy（增强指数策略）

**原理：**
```
1. 从基准指数中选择资产
2. 使用因子模型优化权重
3. 控制换手率和跟踪误差
4. 目标：在控制风险的同时超越基准
```

**适用场景：**
- 指数增强
- 有风险模型
- 想要超越基准指数

**参数：**
- `riskmodel_root`: 风险模型路径
- `turn_limit`: 换手率限制（默认 0.3）
- `market`: 市场代码（默认 csi500）

**优点：**
- ✅ 主动管理与被动投资结合
- ✅ 控制跟踪误差
- ✅ 系统化风险控制

**缺点：**
- ❌ 需要风险模型
- ❌ 计算复杂度高
- ❌ 对基准依赖强

---

### 规则策略

#### 1. SBB Strategy（Select Better Between Bars）

**原理：**
```
(S)elect (B)etter one among every two adjacent trading (B)ars

1. 比较相邻两个 K 线的收盘价
2. 如果后一根 K 线更高 → 买入
3. 如果后一根 K 线更低 → 卖出
4. 否则保持当前仓位
```

**适用场景：**
- 震荡市场
- 短期交易
- 捕捉微小波动

**参数：**
- 无参数（直接比较相邻 K 线）

**优点：**
- ✅ 极其简单，无需复杂计算
- ✅ 反应迅速
- ✅ 适合高频交易

**缺点：**
- ❌ 噪音过多，容易亏损
- ❌ 交易成本高
- ❌ 在趋势市场中表现差

---

#### 2. SBB EMA Strategy（带 EMA 的 SBB 策略）

**原理：**
```
(S)elect (B)etter one among every two adjacent trading (B)ars with (EMA)

1. 计算 EMA 作为趋势过滤器
2. 在上升趋势中，价格上涨 → 买入
3. 在上升趋势中，价格下跌 → 卖出（止损）
4. 在下降趋势中，价格下跌 → 做空
5. 在下降趋势中，价格上涨 → 平空
```

**适用场景：**
- 趋势市场
- 中短期交易
- 需要趋势过滤

**参数：**
- `ema_period`: EMA 周期（默认 20）

**优点：**
- ✅ 加入了趋势过滤
- ✅ 减少逆势交易
- ✅ 比 SBB 更稳定

**缺点：**
- ❌ EMA 滞后性
- ❌ 参数敏感
- ❌ 在震荡市场容易频繁止损

---

#### 3. TWAP Strategy（Time-Weighted Average Price）

**原理：**
```
1. 在固定时间段内分批执行交易
2. 平均分散交易时间
3. 减少市场冲击
4. 适合大额资金执行
```

**注意：**
- TWAP 主要是**执行策略**，不是信号策略
- 适合与信号策略结合使用
- 在我们的实现中简化为固定时间间隔交易

**适用场景：**
- 大额资金执行
- 减少滑点
- 算法交易执行

**参数：**
- `execution_period`: 执行周期（默认 60 分钟）

**优点：**
- ✅ 减少市场冲击
- ✅ 平滑执行
- ✅ 适合大额资金

**缺点：**
- ❌ 不是信号策略
- ❌ 需要与其他策略结合
- ❌ 在单资产回测中效果有限

---

## 三、回测结果（2023年，1分钟级别）

### 数据说明

- **合约**: RB9999.XSGE（螺纹钢主力连续）
- **时间范围**: 2023-01-03 ~ 2023-12-29
- **数据量**: 82,770 行（1分钟 K线）
- **基准**: 买入持有收益 -1.65%

### 回测结果汇总

| 策略 | 类型 | 交易次数 | 累计收益 | 年化收益 | 最大回撤 | 夏普比率 | 胜率 | 排名 |
|--------|------|----------|----------|----------|----------|----------|------|------|
| **Enhanced Indexing** | 信号 | 966 | **92.18%** | **61.18%** | **2.25%** | **8.11** | **60.76%** | 🥇 |
| **TWAP** | 规则 | 1,439 | 0.04% | 0.03% | 3.44% | 0.02 | 49.04% | 🥈 |
| **TopK** | 信号 | 13,169 | -54.36% | -43.63% | 55.25% | -3.63 | 47.57% | 🥉 |
| **SBB** | 规则 | 55,915 | -98.52% | -95.40% | 98.54% | -21.26 | 43.41% | ❌ |
| **SBB EMA** | 规则 | 55,915 | -98.52% | -95.40% | 98.54% | -21.26 | 43.41% | ❌ |

### 详细分析

#### 🥇 Enhanced Indexing Strategy - 表现最佳

**结果：**
- ✅ 累计收益: **92.18%**
- ✅ 年化收益: **61.18%**
- ✅ 最大回撤: 2.25%
- ✅ 夏普比率: **8.11**
- ✅ 胜率: 60.76%
- ✅ 交易次数适中: 966 次

**分析：**
- 本质上是均值回归策略（类似布林带）
- 在 2023 年螺纹钢市场表现优异
- 收益高、回撤小、夏普比率优秀
- 明显优于买入持有基准（-1.65%）

**为什么效果好？**
1. 2023 年螺纹钢市场震荡为主
2. 均值回归策略在震荡市场有效
3. 参数合理（20日窗口，2倍标准差）
4. 风险控制良好

---

#### 🥈 TWAP Strategy - 表现一般

**结果：**
- 累计收益: 0.04%
- 年化收益: 0.03%
- 最大回撤: 3.44%
- 夏普比率: 0.02
- 胜率: 49.04%
- 交易次数少: 1,439 次

**分析：**
- TWAP 本质上是执行策略，不是信号策略
- 我们的实现简化为固定时间间隔买入
- 表现与随机相当（接近 0%）
- 不适合单资产信号策略

**为什么效果一般？**
1. 没有真正的交易信号
2. 只是定期买入，缺乏择时
3. 在下跌市场中持续亏损
4. 需要与信号策略结合

---

#### 🥉 TopK Strategy - 表现较差

**结果：**
- ❌ 累计收益: -54.36%
- ❌ 年化收益: -43.63%
- ❌ 最大回撤: 55.25%
- ❌ 夏普比率: -3.63
- ❌ 胜率: 47.57%
- ❌ 交易次数最多: 13,169 次

**分析：**
- 基于简单的动量信号（20日收益率）
- 在震荡市场中动量策略表现差
- 高频交易导致成本累积
- 胜率接近 50%，无显著优势

**为什么效果差？**
1. 2023 年螺纹钢市场震荡，无明确趋势
2. 动量策略在震荡市场无效
3. 高频交易（13,169次）导致滑点和手续费累积
4. 简单实现不如原始的 TopK 策略

---

#### ❌ SBB Strategy - 表现很差

**结果：**
- ❌ 累计收益: **-98.52%**
- ❌ 年化收益: **-95.40%**
- ❌ 最大回撤: **98.54%**
- ❌ 夏普比率: **-21.26**
- ❌ 胜率: 43.41%
- ❌ 交易次数极多: 55,915 次

**分析：**
- 极其简单：比较相邻 K 线涨跌
- 噪音过多，导致频繁交易
- 几乎每个 bar 都在交易
- 在 1 分钟级别完全失效

**为什么效果很差？**
1. 相邻 1 分钟 K 线涨跌是纯噪音
2. 高频交易（55,915次）导致巨额成本
3. 没有任何趋势过滤或风险控制
4. 在单资产回测中暴露了 SBB 的缺陷

---

#### ❌ SBB EMA Strategy - 表现很差

**结果：**
- ❌ 累计收益: **-98.52%**
- ❌ 年化收益: **-95.40%**
- ❌ 最大回撤: **98.54%**
- ❌ 夏普比率: **-21.26**
- ❌ 胜率: 43.41%
- ❌ 交易次数极多: 55,915 次

**分析：**
- 加入了 EMA 趋势过滤
- 但仍然频繁交易
- EMA 滞后性导致逆势交易
- 在 1 分钟级别表现更差

**为什么效果很差？**
1. EMA 在 1 分钟级别信号混乱
2. 趋势频繁变化，导致反复止损
3. 高频交易导致成本累积
4. 即使有趋势过滤，仍然噪音过多

---

## 四、策略对比总结

### 按表现排序

1. **Enhanced Indexing** 🥇
   - 累计收益: 92.18%
   - 最佳表现，适合震荡市场

2. **TWAP** 🥈
   - 累计收益: 0.04%
   - 表现平庸，需要改进

3. **TopK** 🥉
   - 累计收益: -54.36%
   - 在震荡市场失效

4. **SBB / SBB EMA** ❌
   - 累计收益: -98.52%
   - 在 1 分钟级别完全失效

### 关键发现

#### 1. 策略类型与市场环境的匹配

| 策略类型 | 适用市场 | 2023年表现 | 原因 |
|----------|----------|------------|------|
| **均值回归** | 震荡市场 | ✅ 优秀（92.18%） | 2023年震荡为主 |
| **动量策略** | 趋势市场 | ❌ 失效（-54.36%） | 2023年无明确趋势 |
| **规则策略** | 低频交易 | ❌ 1分钟级失效 | 噪音过多 |

#### 2. 交易频率与成本的关系

| 策略 | 交易次数 | 成本影响 | 结论 |
|------|----------|----------|------|
| Enhanced Indexing | 966 | 低 | ✅ 适中 |
| TopK | 13,169 | 高 | ❌ 成本过高 |
| SBB / SBB EMA | 55,915 | 极高 | ❌ 成本毁灭收益 |

#### 3. 胜率与收益的关系

| 策略 | 胜率 | 累计收益 | 结论 |
|------|------|----------|------|
| Enhanced Indexing | 60.76% | 92.18% | ✅ 高胜率 + 高收益 |
| SBB / SBB EMA | 43.41% | -98.52% | ❌ 低胜率 + 巨亏 |

**结论：** 高胜率不一定带来高收益，但低胜率必然导致亏损。

---

## 五、实际应用建议

### 1. 推荐 Enhanced Indexing 策略

**使用场景：**
- ✅ 震荡市场（如 2023 年螺纹钢）
- ✅ 中短期交易（1-5分钟）
- ✅ 风险敏感型投资者

**优化建议：**
1. 调整参数（窗口周期、标准差倍数）
2. 加入止损止盈
3. 优化仓位管理
4. 组合其他指标过滤

### 2. 避免 SBB / SBB EMA 策略

**原因：**
- ❌ 高频交易导致成本过高
- ❌ 噪音过多，信号质量差
- ❌ 在 1 分钟级别完全失效

**替代方案：**
- 使用更长的周期（日线、周线）
- 加入趋势过滤器
- 降低交易频率

### 3. TopK 策略的改进

**问题：**
- 简单动量信号在震荡市场失效

**改进方案：**
1. 使用更复杂的因子模型
2. 加入风险控制
3. 降低换手率
4. 市场环境判断（趋势 vs 震荡）

### 4. TWAP 策略的正确用法

**问题：**
- 单独使用效果差（0.04%）

**正确用法：**
TWAP 应该与信号策略结合使用，用于分批执行大额订单，而不是作为信号策略本身。

---

## 六、总结

### 最佳策略：Enhanced Indexing（均值回归）

**回测结果：**
- 累计收益: **92.18%**
- 年化收益: **61.18%**
- 最大回撤: 2.25%
- 夏普比率: **8.11**
- 胜率: 60.76%

### 最差策略：SBB / SBB EMA

**回测结果：**
- 累计收益: **-98.52%**
- 年化收益: **-95.40%**
- 最大回撤: **98.54%**
- 夏普比率: **-21.26**
- 胜率: 43.41%

**关键教训：**
1. ❌ 高频规则策略在 1 分钟级失效
2. ❌ 噪音过多导致巨大亏损
3. ❌ 交易成本毁灭收益
4. ❌ 需要更长周期或趋势过滤

---

**文档版本**: v1.0
**创建时间**: 2025-02-15
**回测数据**: RB9999.XSGE, 2023年, 1分钟级别
